#!/bin/bash

echo "======================================="
echo " ğŸ” Fix Next.js Critical Vulnerabilities"
echo "======================================="

# ----- CONFIGURAÃ‡Ã•ES -----
SAFE_VERSION="15.5.7"   # vocÃª pode trocar por 16.0.7 se desejar usar Next 16
NODE_MODULES="./node_modules"


echo ""
echo "ğŸ“Œ Verificando versÃ£o atual do Next.js..."
NEXT_VERSION=$(yarn list --pattern next | grep next@ | sed 's/.*next@//')
echo "   â†’ VersÃ£o encontrada: $NEXT_VERSION"

echo ""
echo "âš ï¸ Limpando caches e dependÃªncias antigas..."
rm -rf $NODE_MODULES
rm -rf .next
yarn cache clean

echo ""
echo "â¬†ï¸ Atualizando Next.js para versÃ£o segura: $SAFE_VERSION"
yarn add next@$SAFE_VERSION

echo ""
echo "â¬†ï¸ Atualizando React e React-DOM para as Ãºltimas versÃµes estÃ¡veis..."
yarn add react@latest react-dom@latest

echo ""
echo "ğŸ“¦ Reinstalando todas as dependÃªncias..."
yarn install

echo ""
echo "ğŸ“ Rodando build para verificar integridade..."
yarn build || {
    echo "âŒ Build falhou! Verifique os erros antes de continuar."
    exit 1
}

echo ""
echo "ğŸ” Rodando auditoria de vulnerabilidades..."
yarn audit || echo "âš ï¸ Auditoria retornou mensagens, revise se necessÃ¡rio."

echo ""
echo "ğŸ› ï¸ Aplicando patch oficial contra React2Shell (RCE)"
npx fix-react2shell-next

echo ""
echo "ğŸ§ª Build final apÃ³s fixes..."
yarn build || {
    echo "âŒ Build falhou apÃ³s patch! Ã‰ necessÃ¡rio revisar."
    exit 1
}

echo ""
echo "âœ… Tudo concluÃ­do!"
echo "Sua aplicaÃ§Ã£o Next.js agora estÃ¡ usando uma versÃ£o segura ($SAFE_VERSION) e estÃ¡ protegida contra:"
echo " - CVE-2025-55182 (RCE via React Server Components)"
echo " - CVE-2025-66478 (Next.js RCE)"
echo " - CVE-2025-29927 (Middleware Auth Bypass)"
echo ""
echo "RecomendaÃ§Ãµes finais:"
echo " - FaÃ§a deploy somente apÃ³s o build passar sem erros."
echo " - Caso use Docker, gere uma nova imagem a partir dessa versÃ£o fixada."
echo " - Caso tenha vÃ¡rios projetos, execute este script em todos."
echo ""
